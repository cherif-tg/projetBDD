<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station-Service - Facturation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c7cce5ff 0%, #a599b2ff 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #a9c5e1ff 0%, #7fb4e9ff 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #3498db;
            border-radius: 0 0 8px 10px;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #bdc3c7;
            border: none;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #95a5a6;
        }
        
        .tab.active {
            background: #72c2f7ff;
            color: white;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #75bbeaff;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #69b2e2ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #79beedff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        
        .btn-success {
            background: #6ae69eff;
            color: white;
        }
        
        .btn-success:hover {
            background: #63e097ff;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #f36f60ff;
            color: white;
        }
        
        .ligne-facture {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid #9ed3f7ff;
        }
        
        .ligne-facture-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 60px;
            gap: 10px;
            align-items: end;
        }
        
        .totaux {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .totaux-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            font-size: 16px;
        }
        
        .totaux-row.total {
            background: #6ebdf2ff;
            color: white;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #78beecff;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #6eeaa1ff;
            color: white;
        }
        
        .badge-warning {
            background: #f1c276ff;
            color: white;
        }
        
        .badge-danger {
            background: #db796eff;
            color: white;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #78eb92ff;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #b7666eff;
            border: 1px solid #f5c6cb;
        }

        /* Modal Paiement */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 420px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .modal-header { font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó Station-Service </h1>
            <p>Syst√®me de Facturation Informatis√©</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="showSection(this, 'dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showSection(this, 'clients')">üë• Clients</button>
            <button class="tab" onclick="showSection(this, 'services')">üõ†Ô∏è Services</button>
            <button class="tab" onclick="showSection(this, 'facture')">üßæ Nouvelle Facture</button>
            <button class="tab" onclick="showSection(this, 'liste')">üìã Liste Factures</button>
        </div>
        
        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="section active">
                <h2>Tableau de Bord</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: linear-gradient(135deg, #a8b5efff 0%, #d3b5f1ff 100%); padding: 30px; border-radius: 10px; color: white;">
                        <h3>CA Aujourd'hui</h3>
                        <p style="font-size: 2em; font-weight: bold;" id="ca_jour"> 0  FCFA</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #e9aef0ff 0%, #ea6f80ff 100%); padding: 30px; border-radius: 10px; color: white;">
                        <h3>Factures du jour</h3>
                        <p style="font-size: 2em; font-weight: bold;" id="nb_factures">0</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #73ade1ff 0%, #78e3e9ff 100%); padding: 30px; border-radius: 10px; color: white;">
                        <h3>Impay√©s</h3>
                        <p style="font-size: 2em; font-weight: bold;" id="montant_impaye"> 0  FCFA</p>
                    </div>
                </div>
            </div>
            
            <!-- CLIENTS -->
            <div id="clients" class="section">
                <h2>Gestion des Clients</h2>
                <div id="alert-client"></div>
                
                <div style="background: #c6def5ff; padding: 25px; border-radius: 08px; margin-top: 20px;">
                    <h3>Ajouter un Client</h3>
                    <form id="form-client">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label>Nom *</label>
                                <input type="text" id="client_nom" required placeholder="ZIZOU">
                            </div>
                            <div class="form-group">
                                <label>Pr√©nom</label>
                                <input type="text" id="client_prenom" placeholder="kpatcha">
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="client_telephone" placeholder="90857151">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="client_email", placeholder="tonnom@gmail.com">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success"> **Enregistrer Client**</button>
                    </form>
                </div>
                
                <table id="table-clients">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Pr√©nom</th>
                            <th>T√©l√©phone</th>
                            <th>Email</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- SERVICES -->
            <div id="services" class="section">
                <h2>Catalogue des Services</h2>
                <table id="table-services">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Libell√©</th>
                            <th>Prix HT</th>
                            <th>TVA</th>
                            <th>Cat√©gorie</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- NOUVELLE FACTURE -->
            <div id="facture" class="section">
                <h2>Cr√©er une Facture</h2>
                <div id="alert-facture"></div>
                
                <form id="form-facture">
                    <div class="form-group">
                        <label>S√©lectionner un Client *</label>
                        <select id="facture_client" required>
                            <option value=""> Choisir un client </option>
                        </select>
                    </div>
                    
                    <h3>Lignes de Facture</h3>
                    <div id="lignes-container"></div>
                    
                    <button type="button" class="btn btn-primary" onclick="ajouterLigne()">+ Ajouter une ligne</button>
                    
                    <div class="totaux">
                        <div class="totaux-row">
                            <span>Total HT:</span>
                            <strong id="total_ht">0.00 FCFA</strong>
                        </div>
                        <div class="totaux-row">
                            <span>Total TVA:</span>
                            <strong id="total_tva">0.00 FCFA</strong>
                        </div>
                        <div class="totaux-row total">
                            <span>TOTAL TTC:</span>
                            <strong id="total_ttc">0.00 FCFA</strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Observations</label>
                        <textarea id="facture_observations" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="font-size: 18px; padding: 15px 40px;">
                        -- Enregistrer et Imprimer Facture --
                    </button>
                </form>
            </div>
            
            <!-- LISTE FACTURES -->
            <div id="liste" class="section">
                <h2>Liste des Factures</h2>
                <table id="table-factures">
                    <thead>
                        <tr>
                            <th>N¬∞ Facture</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Montant TTC</th>
                            <th>Pay√©</th>
                            <th>Solde</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Paiement -->
    <div id="modal-payment" class="modal" onclick="if(event.target.id==='modal-payment') closePaymentModal()">
        <div class="modal-card">
            <div class="modal-header">Enregistrer un paiement</div>
            <form id="form-payment" onsubmit="submitPayment(event)">
                <input type="hidden" id="payment_facture_id">
                <div class="form-group">
                    <label>Montant</label>
                    <input type="number" id="payment_montant" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Mode de paiement</label>
                    <select id="payment_mode">
                        <option value="ESPECES">ESPECES</option>
                        <option value="CARTE">CARTE</option>
                        <option value="CHEQUE">CHEQUE</option>
                        <option value="VIREMENT">VIREMENT</option>
                        <option value="AUTRE">AUTRE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>R√©f√©rence</label>
                    <input type="text" id="payment_reference">
                </div>
                <div class="form-group">
                    <label>Observations</label>
                    <textarea id="payment_observations" rows="2"></textarea>
                </div>
                <div id="payment_alert"></div>
                <div style="text-align:right; margin-top:8px;">
                    <button type="button" class="btn btn-danger" onclick="closePaymentModal()">Annuler</button>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration API (chemin relatif)
        const API_URL = '/api';
        
        let clients = [];
        let services = [];
        let ligneIndex = 0;
        
        // Navigation entre sections
        function showSection(buttonEl, sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');
            if (buttonEl && buttonEl.classList) buttonEl.classList.add('active');

            // Charger les donn√©es selon la section
            if (sectionId === 'clients') chargerClients();
            if (sectionId === 'services') chargerServices();
            if (sectionId === 'facture') initialiserFacture();
            if (sectionId === 'liste') chargerFactures();
            if (sectionId === 'dashboard') chargerDashboard();
        }
        
        // Charger Dashboard
        async function chargerDashboard() {
            try {
                // Pas d'endpoint d√©di√© dans le backend pour l'instant, valeurs simul√©es
                document.getElementById('ca_jour').textContent = '2 450.00 FCFA';
                document.getElementById('nb_factures').textContent = '12';
                document.getElementById('montant_impaye').textContent = '850.00 FCFA';
            } catch (error) {
                console.error('Erreur dashboard:', error);
            }
        }
        
        // Charger clients
        async function chargerClients() {
            try {
                const response = await fetch(`${API_URL}/clients`);
                if (!response.ok) throw new Error('Erreur r√©seau: ' + response.status);
                clients = await response.json();
                
                const tbody = document.querySelector('#table-clients tbody');
                tbody.innerHTML = clients.map(c => `
                    <tr>
                        <td>${c.nom}</td>
                        <td>${c.prenom || '-'}</td>
                        <td>${c.telephone || '-'}</td>
                        <td>${c.email || '-'}</td>
                        <td>${c.type_client}</td>
                    </tr>
                `).join('');
                
                // Remplir select
                const select = document.getElementById('facture_client');
                select.innerHTML = '<option value="">-- Choisir un client --</option>' +
                    clients.map(c => `<option value="${c.id_client}">${c.nom} ${c.prenom || ''}</option>`).join('');
                    
            } catch (error) {
                console.error('Erreur chargement clients:', error);
                document.getElementById('alert-client').innerHTML = '<div class="alert alert-error">Erreur chargement clients</div>';
            }
        }
        
        // Charger services
        async function chargerServices() {
            try {
                const response = await fetch(`${API_URL}/services`);
                if (!response.ok) throw new Error('Erreur r√©seau: ' + response.status);
                services = await response.json();
                
                const tbody = document.querySelector('#table-services tbody');
                tbody.innerHTML = services.map(s => `
                    <tr>
                        <td>${s.code_service}</td>
                        <td>${s.libelle}</td>
                        <td>${s.prix_unitaire_ht} ‚Ç¨</td>
                        <td>${s.taux_tva}%</td>
                        <td>${s.categorie}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement services:', error);
            }
        }
        
        // Initialiser formulaire facture
        function initialiserFacture() {
            if (services.length === 0) chargerServices();
            if (clients.length === 0) chargerClients();
            ajouterLigne();
        }
        
        // Ajouter ligne facture
        function ajouterLigne() {
            const container = document.getElementById('lignes-container');
            const div = document.createElement('div');
            div.className = 'ligne-facture';
            div.id = `ligne-${ligneIndex}`;
            
            div.innerHTML = `
                <div class="ligne-facture-grid">
                    <div class="form-group">
                        <label>Service</label>
                        <select onchange="updateLigne(${ligneIndex})">
                            <option value="">-- Choisir --</option>
                            ${services.map(s => `<option value="${s.id_service}" 
                                data-prix="${s.prix_unitaire_ht}" 
                                data-tva="${s.taux_tva}">
                                ${s.libelle} - ${s.prix_unitaire_ht}‚Ç¨
                            </option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantit√©</label>
                        <input type="number" step="0.01" value="1" min="0.01" onchange="updateLigne(${ligneIndex})">
                    </div>
                    <div class="form-group">
                        <label>Prix HT</label>
                        <input type="number" step="0.01" value="0" readonly>
                    </div>
                    <div class="form-group">
                        <label>Total TTC</label>
                        <input type="number" step="0.01" value="0" readonly>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="retirerLigne(${ligneIndex})" style="margin-top: 25px;">‚úï</button>
                </div>
            `;
            
            container.appendChild(div);
            ligneIndex++;
        }
        
        // Mettre √† jour ligne
        function updateLigne(index) {
            const ligne = document.getElementById(`ligne-${index}`);
            const select = ligne.querySelector('select');
            const option = select.options[select.selectedIndex];
            const quantite = parseFloat(ligne.querySelectorAll('input')[0].value) || 0;
            
            const prixHT = parseFloat(option.dataset.prix) || 0;
            const tauxTVA = parseFloat(option.dataset.tva) || 0;
            
            const montantHT = quantite * prixHT;
            const montantTTC = montantHT * (1 + tauxTVA / 100);
            
            ligne.querySelectorAll('input')[1].value = prixHT.toFixed(2);
            ligne.querySelectorAll('input')[2].value = montantTTC.toFixed(2);
            
            calculerTotaux();
        }
        
        // Retirer ligne
        function retirerLigne(index) {
            document.getElementById(`ligne-${index}`).remove();
            calculerTotaux();
        }
        
        // Calculer totaux
        function calculerTotaux() {
            let totalHT = 0, totalTVA = 0, totalTTC = 0;
            
            document.querySelectorAll('.ligne-facture').forEach(ligne => {
                const select = ligne.querySelector('select');
                const option = select.options[select.selectedIndex];
                const quantite = parseFloat(ligne.querySelectorAll('input')[0].value) || 0;
                const prixHT = parseFloat(option.dataset.prix) || 0;
                const tauxTVA = parseFloat(option.dataset.tva) || 0;
                
                const mHT = quantite * prixHT;
                const mTVA = mHT * (tauxTVA / 100);
                const mTTC = mHT + mTVA;
                
                totalHT += mHT;
                totalTVA += mTVA;
                totalTTC += mTTC;
            });
            
            document.getElementById('total_ht').textContent = totalHT.toFixed(2) + ' FCFA';
            document.getElementById('total_tva').textContent = totalTVA.toFixed(2) + ' FCFA';
            document.getElementById('total_ttc').textContent = totalTTC.toFixed(2) + ' FCFA';
        }
        
        // Soumettre client
        document.getElementById('form-client').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                nom: document.getElementById('client_nom').value,
                prenom: document.getElementById('client_prenom').value,
                telephone: document.getElementById('client_telephone').value,
                email: document.getElementById('client_email').value,
                type_client: 'particulier'
            };
            
            try {
                const response = await fetch(`${API_URL}/clients`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('alert-client').innerHTML = 
                        '<div class="alert alert-success">‚úì Client ajout√© avec succ√®s!</div>';
                    document.getElementById('form-client').reset();
                    chargerClients();
                    setTimeout(() => document.getElementById('alert-client').innerHTML = '', 3000);
                }
            } catch (error) {
                document.getElementById('alert-client').innerHTML = 
                    '<div class="alert alert-error">‚úï Erreur: ' + error.message + '</div>';
            }
        });
        
        // Soumettre facture
        document.getElementById('form-facture').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const lignes = [];
            document.querySelectorAll('.ligne-facture').forEach(ligne => {
                const select = ligne.querySelector('select');
                const option = select.options[select.selectedIndex];
                const quantite = parseFloat(ligne.querySelectorAll('input')[0].value);
                
                if (select.value && quantite > 0) {
                    lignes.push({
                        id_service: parseInt(select.value),
                        quantite: quantite,
                        prix_unitaire_ht: parseFloat(option.dataset.prix),
                        taux_tva: parseFloat(option.dataset.tva)
                    });
                }
            });
            
            if (lignes.length === 0) {
                alert('Veuillez ajouter au moins une ligne √† la facture');
                return;
            }
            
            const data = {
                id_client: parseInt(document.getElementById('facture_client').value),
                observations: document.getElementById('facture_observations').value,
                lignes: lignes
            };
            
            try {
                const response = await fetch(`${API_URL}/factures`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('alert-facture').innerHTML = 
                        '<div class="alert alert-success">‚úì Facture cr√©√©e: ' + result.facture.numero_facture + '</div>';
                    
                    // R√©initialiser formulaire
                    document.getElementById('form-facture').reset();
                    document.getElementById('lignes-container').innerHTML = '';
                    ajouterLigne();
                    calculerTotaux();
                    
                    // T√©l√©charger PDF
                    window.open(`${API_URL}/factures/${result.facture.id_facture}/pdf`, '_blank');
                }
            } catch (error) {
                document.getElementById('alert-facture').innerHTML = 
                    '<div class="alert alert-error">‚úï Erreur: ' + error.message + '</div>';
            }
        });
        
        // Charger factures
        async function chargerFactures() {
            try {
                const response = await fetch(`${API_URL}/factures`);
                const factures = await response.json();
                
                const tbody = document.querySelector('#table-factures tbody');
                tbody.innerHTML = factures.map(f => `
                    <tr>
                        <td><strong>${f.numero_facture}</strong></td>
                        <td>${new Date(f.date_facture).toLocaleDateString('fr-FR')}</td>
                        <td>${f.client}</td>
                        <td>${f.montant_ttc.toFixed(2)} ‚Ç¨</td>
                        <td>${f.montant_paye.toFixed(2)} ‚Ç¨</td>
                        <td>${f.solde_restant.toFixed(2)} ‚Ç¨</td>
                        <td>
                            <span class="badge badge-${f.statut === 'PAYEE' ? 'success' : f.statut === 'PARTIELLEMENT_PAYEE' ? 'warning' : 'danger'}">
                                ${f.statut}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="window.open('${API_URL}/factures/${f.id_facture}/pdf', '_blank')" style="padding: 5px 10px; font-size: 12px;">
                                üìÑ PDF
                            </button>
                                    <button class="btn btn-success" onclick="openPaymentModal(${f.id_facture}, ${f.solde_restant})" style="padding: 5px 10px; font-size: 12px; margin-left:6px;">
                                        üí≥ Paiement
                                    </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement factures:', error);
                showGlobalAlert('Erreur chargement factures: ' + (error.message || error));
            }
        }

        // Paiements : modal handling
        function openPaymentModal(id_facture, solde) {
            document.getElementById('payment_facture_id').value = id_facture;
            document.getElementById('payment_montant').value = solde.toFixed(2);
            document.getElementById('payment_alert').innerHTML = '';
            document.getElementById('modal-payment').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('modal-payment').classList.remove('active');
        }

        async function submitPayment(event) {
            event.preventDefault();
            const id_facture = parseInt(document.getElementById('payment_facture_id').value);
            const montant = parseFloat(document.getElementById('payment_montant').value);
            const mode = document.getElementById('payment_mode').value;
            const reference = document.getElementById('payment_reference').value;
            const observations = document.getElementById('payment_observations').value;

            if (!id_facture || !montant || montant <= 0) {
                document.getElementById('payment_alert').innerHTML = '<div class="alert alert-error">Montant invalide</div>';
                return;
            }

            try {
                const resp = await fetch(`${API_URL}/paiements`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        id_facture: id_facture,
                        montant: montant,
                        mode_paiement: mode,
                        reference_paiement: reference,
                        observations: observations
                    })
                });

                const result = await resp.json();
                if (result.success) {
                    document.getElementById('payment_alert').innerHTML = '<div class="alert alert-success">Paiement enregistr√©</div>';
                    // rafra√Æchir la liste
                    chargerFactures();
                    setTimeout(() => closePaymentModal(), 900);
                } else {
                    document.getElementById('payment_alert').innerHTML = '<div class="alert alert-error">Erreur: ' + (result.error || 'inconnu') + '</div>';
                }
            } catch (err) {
                document.getElementById('payment_alert').innerHTML = '<div class="alert alert-error">Erreur r√©seau</div>';
            }
        }
        
        // Affiche une alerte globale pour erreurs de chargement
        function showGlobalAlert(message, type='error') {
            const container = document.querySelector('.content');
            const html = `<div class="alert ${type==='error' ? 'alert-error' : 'alert-success'}" style="margin-bottom:10px;">${message}</div>`;
            container.insertAdjacentHTML('afterbegin', html);
            setTimeout(() => {
                const el = container.querySelector('.alert');
                if (el) el.remove();
            }, 4000);
        }

        // Initialisation
        window.onload = () => {
            chargerDashboard();
            chargerServices();
            chargerClients();
            // charger la liste des factures pour affichage
            chargerFactures();
        };
    </script>
</body>
</html>